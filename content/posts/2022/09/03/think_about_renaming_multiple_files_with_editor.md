---
title: "複数のファイル名をエディタで一括リネームすることについて考える"
date: 2022-09-03T00:11:55+09:00
draft: false
---

題名のとおり、複数のファイル名をエディタで一括リネームしたい場合がある。
自分は基本的にVSCodeを利用しているが、マルチカーソル機能を利用して編集すると正確で早い編集ができる。
今回、Goでプログラムを書いたのでその際に考えたことを残す。

<!--more-->

## もしツールを探している場合

もし、好きなエディタでリネームするツールを探しているのであれば、下記をオススメしたい。

https://github.com/itchyny/mmv

下記の点が自分の要望を充分満たしており、シンプルなのがとても良いと思った。
- VSCodeで利用できる
- Undo機能がある(一部リネームに失敗した場合、最初の状態に戻る)
- 対象をgrepできる
- 移動先のディレクトリが存在しなければ、作成してファイルを移動する

自作のプログラムを一通り完成させた後に中身を見たので、自身のコードと比較できて勉強になった。

## どうやって一括リネームするか

### リネームはos.Rename()関数を使う

Goでリネームするには、`os.Rename()`関数を使えばいい。

> func Rename(oldpath, newpath string) error
>
> Rename renames (moves) oldpath to newpath. If newpath already exists and is not a directory, Rename replaces it. OS-specific restrictions may apply when oldpath and newpath are in different directories. If there is an error, it will be of type *LinkError.
>
> 引用: https://pkg.go.dev/os#Rename

既存のファイルパスとリネーム後のファイルパスを引数とすればよい。
今回は、エディタでテキスト編集をしてリネームするので、下記の流れとした。

1. カレントディレクトリのファイル名を取得
2. Tempファイルの作成
3. 1のファイル名をTempファイルに書き込み
4. 任意のエディタでTempファイルを開く
5. ファイル名を編集後、Tempファイルの内容を読み取りリネームを実行
6. 不要なTempファイルは削除

以上の流れで特に難しいことはない。
ただし、リネームを実行するにあたって、ファイル名が重複しないことに気をつける必要がある。

### ファイル名が重複しないようにする

`os.Rename()`関数は、`newpath`がすでに存在する場合、`oldpath`を`newpath`に置き換える。つまり、ファイル名が重複すると、ファイルが消える。

そこで、ファイル名が重複するパターンを以下の２つに分けて考えた。

1. リネーム後のファイル名同士が重複
2. リネーム後のファイル名が、元々存在するファイル名と重複

#### 1. リネーム後のファイル名同士が重複

これは、下記のような操作をエラーとすれば良い。

```
a.txt -> c.txt 
b.txt -> c.txt
```

#### ２. リネーム後のファイル名が、元々存在するファイル名と重複

例えば、下記のように上から順番にリネームすると元々存在した`b.txt`というファイルが`a.txt`の内容で上書きされてしまう。そのため、最終的に`c.txt`しか残らない。

```
a.txt -> b.txt 
b.txt -> c.txt
```

そこで、このパターンは既存のファイル名と被らないtemporaryのファイル名を与えることとした。
既存ファイルを対象にしたリネームの終了後、temporaryのファイルに対してもリネームを実行すればOK。

```
a.txt -> temp-ee31dee3ab9545918b99d72115b0c522 
b.txt -> c.txt
temp-ee31dee3ab9545918b99d72115b0c522 -> b.txt
```

## さいごに

とりあえず、自分にとって最低限必要な動作を実装することができた。
検索すればツールは色々あるとは思っていたが、どうすればシンプルに解決できるかを自分で考えて実装するのは楽しい。

https://github.com/matsuhaya/textrn


なお、[mmvの紹介記事](https://itchyny.hatenablog.com/entry/2020/01/10/100000)をみると、巡回するパターンはリネームを逆順にすればよい、とあった。

```
a.txt -> b.txt 
b.txt -> c.txt
```

上記は、逆順にすればtemporaryのファイル名を与えなくてもOK。

```
[逆順]
b.txt -> c.txt
a.txt -> b.txt 
```

なるほど。
